package {{ .PackageName }}

import (
    "testing"

    "github.com/hedhyw/gherkingen/v2/pkg/bdd"
)

{{ define "Background" }}
    {{ $Background := . }}
    f.{{ $Background.PluginData.GoName }}({{ $Background.PluginData.GoValue }}, func(t *testing.T, f *bdd.Feature) {
        {{- range $Background.Steps }}
        f.{{ .PluginData.GoName }}({{.PluginData.GoValue}}, func() {
            
        })
        {{- end }}
    })
{{ end }}

{{ define "Scenario" }}
    {{ $Scenario := . }}
    f.{{ $Scenario.PluginData.GoName }}({{ $Scenario.PluginData.GoValue }}, func(t *testing.T, f *bdd.Feature) {
        {{- range $Scenario.Examples }}

        {{- /* Define test case struct. */ -}}

        type testCase struct {
            {{- range .TableHeader.Cells }}
			{{ .PluginData.GoName }} {{ .PluginData.GoType }} `field:"{{.Value}}"`
            {{- end -}}
		}

        testCases := map[string]testCase{
            {{- range .TableBody }}
			{{ .PluginData.GoValue }}: {
            {{- /* Struct fields start. */ -}}
                {{- range $index, $cell := .Cells -}}
                {{- if $index -}},{{ end }} {{- $cell.PluginData.GoValue -}}
                {{- end -}}
            {{- /* Struct fields end. */ -}}
            },
            {{- end }}
		}

        f.TestCases(testCases, func(t *testing.T, f *bdd.Feature, tc testCase) {
            {{- range $Scenario.Steps }}
            f.{{ .PluginData.GoName }}({{ .PluginData.GoValue }}, func() {
                
            })
            {{- end }}
        })
        {{- else }}
        {{- range $Scenario.Steps }}
        f.{{ .PluginData.GoName }}({{.PluginData.GoValue}}, func() {
            
        })
        {{- end }}
        {{ end }}
    })
{{ end }}

{{ define "Rule" }}
    {{ $Rule := . }}
    f.{{ $Rule.PluginData.GoName }}({{ $Rule.PluginData.GoValue }}, func(t *testing.T, f *bdd.Feature) {
        {{- range $Rule.Children }}

        {{ if .Background }}
        {{ template "Background" .Background }}
        {{- end }}

        {{ if .Scenario }}
        {{ template "Scenario" .Scenario }}
        {{- end }}

        {{ end }}
    })
{{ end }}

func Test{{ .Feature.PluginData.GoName }}(t *testing.T) {
    f := bdd.NewFeature(t, {{ .Feature.PluginData.GoValue }})
    {{ if .Feature.Description }}
    /* {{ .Feature.Description }} */
    {{ end }}

    {{- range .Feature.Children }}

    {{ if .Background }}
    {{ template "Background" .Background }}
    {{- end }}

    {{ if .Scenario }}
    {{ template "Scenario" .Scenario }}
    {{- end }}

    {{ if .Rule }}
    {{ template "Rule" .Rule }}
    {{- end }}

    {{- end }}
}
